name: Use_Local_Ros_Bin_Fix
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ï¼ˆæ‹‰å–æœ¬åœ°ros.binï¼‰
        uses: actions/checkout@v4

      - name: å®‰è£…å·¥å…·
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools u-boot-tools binwalk wget
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ"

      - name: æ‰‹åŠ¨å…‹éš†+ç¼–è¯‘FMKï¼ˆå¼ºåˆ¶æŒ‡å®šè·¯å¾„ï¼ŒåŠ æ‰§è¡Œæƒé™ï¼‰
        run: |
          # å¼ºåˆ¶å…‹éš†åˆ°å½“å‰ç›®å½•ï¼Œé¿å…è·¯å¾„åç§»
          git clone --depth 1 https://github.com/rampageX/firmware-mod-kit.git ./fmk_tool
          # ç»™æ‰€æœ‰è„šæœ¬åŠ å¯æ‰§è¡Œæƒé™
          chmod +x ./fmk_tool/*.sh
          chmod +x ./fmk_tool/src/*/*.sh
          # ç¼–è¯‘FMKæ ¸å¿ƒå·¥å…·
          cd ./fmk_tool/src
          sudo make clean && sudo make
          cd ../../
          # éªŒè¯è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "./fmk_tool/extract-firmware.sh" ]; then
            echo "ERROR: FMKè„šæœ¬ç¼ºå¤±ï¼"
            exit 1
          fi
          ls -l ./fmk_tool/extract-firmware.sh
          echo "âœ… FMKç¼–è¯‘+æƒé™è®¾ç½®å®Œæˆ"

      - name: æ¸…ç†æ®‹ç•™æ–‡ä»¶
        run: sudo rm -rf fmk* ros.bin.extracted final_fw.bin 2>/dev/null

      - name: ç¡®è®¤ros.binå­˜åœ¨å¹¶å¤åˆ¶
        run: |
          if [ ! -f ".github/workflows/ros.bin" ]; then
            echo "ERROR: æœªæ‰¾åˆ°ros.binï¼"
            exit 1
          fi
          cp .github/workflows/ros.bin ./ros.bin
          chmod 644 ./ros.bin
          ls -lh ./ros.bin
          echo "âœ… ros.binåŠ è½½å®Œæˆ"

      - name: å®¹é”™å¼æ‰«æros.binå‚æ•°ï¼ˆè§£å†³å‚æ•°ä¸ºç©ºï¼‰
        id: scan
        run: |
          # å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯uImageæ ¼å¼
          if mkimage -l ./ros.bin 2>/dev/null; then
            export IMAGE_ARCH=$(mkimage -l ./ros.bin | grep -i "Architecture" | awk '{print $3}' | sed 's/://g' || echo "mips")
            export IMAGE_ADDR=$(mkimage -l ./ros.bin | grep -i "Data Address" | awk '{print $4}' || echo "0x80000000")
            export IMAGE_ENTRY=$(mkimage -l ./ros.bin | grep -i "Entry Point" | awk '{print $4}' || echo $IMAGE_ADDR)
            export IMAGE_COMP=$(mkimage -l ./ros.bin | grep -i "Compression" | awk '{print $3}' | sed 's/://g' || echo "lzma")
          else
            # éuImageåˆ™ç”¨é»˜è®¤MIPSå‚æ•°ï¼ˆé€‚é…ros.binï¼‰
            export IMAGE_ARCH="mips"
            export IMAGE_ADDR="0x80000000"
            export IMAGE_ENTRY="0x80000000"
            export IMAGE_COMP="lzma"
          fi
          export IMAGE_NAME=$(mkimage -l ./ros.bin | grep -i "Image Name" | cut -d ':' -f2 | sed 's/ //g' || echo "MIPSPandoraBoxLinux-3.14.79")
          
          # æ‰«æSquashfså‚æ•°ï¼ˆå®¹é”™ï¼‰
          if binwalk -E ./ros.bin | grep -i "Squashfs filesystem"; then
            export SQSH_COMP=$(binwalk -E ./ros.bin | grep -i "Squashfs filesystem" | awk -F ', ' '{for(i=1;i<=NF;i++) if($i ~ /compression:/) print substr($i,12)}' || echo "xz")
          else
            export SQSH_COMP="xz"
          fi
          export SQSH_BLOCK=$(binwalk -E ./ros.bin | grep -i "Squashfs filesystem" | awk -F ', ' '{for(i=1;i<=NF;i++) if($i ~ /blocksize:/) print substr($i,11) | sed 's/ bytes//g'}' || echo "262144")
          export SQSH_SIZE=$(stat -c %s ./ros.bin)
          
          # è¾“å‡ºå‚æ•°
          echo "ğŸ“Œ å‚æ•°ï¼šARCH=$IMAGE_ARCH | ADDR=$IMAGE_ADDR | SQSH_COMP=$SQSH_COMP"
          # å­˜å…¥ç¯å¢ƒå˜é‡
          echo "IMAGE_ARCH=$IMAGE_ARCH" >> $GITHUB_ENV
          echo "IMAGE_ADDR=$IMAGE_ADDR" >> $GITHUB_ENV
          echo "IMAGE_ENTRY=$IMAGE_ENTRY" >> $GITHUB_ENV
          echo "IMAGE_COMP=$IMAGE_COMP" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "SQSH_COMP=$SQSH_COMP" >> $GITHUB_ENV
          echo "SQSH_BLOCK=$SQSH_BLOCK" >> $GITHUB_ENV
          echo "SQSH_SIZE=$SQSH_SIZE" >> $GITHUB_ENV

      - name: ç²¾å‡†æ‰§è¡ŒFMKè§£åŒ…è„šæœ¬ï¼ˆä¿®å¤command not foundï¼‰
        run: |
          # ç”¨ç»å¯¹è·¯å¾„æ‰§è¡Œï¼Œé¿å…ç›¸å¯¹è·¯å¾„é—®é¢˜
          FMK_PATH=$(pwd)/fmk_tool
          sudo $FMK_PATH/extract-firmware.sh ./ros.bin || true
          # å…¼å®¹æ‰€æœ‰å¯èƒ½çš„è§£åŒ…ç›®å½•
          if [ -d "fmk/rootfs" ]; then
            mv fmk ros.bin.extracted
          elif [ -d "ros.bin.extracted/rootfs" ]; then
            echo "ç›®å½•æ­£å¸¸"
          else
            echo "WARNING: æœªæ‰¾åˆ°rootfsï¼Œä½†ç»§ç»­æ‰§è¡Œæ‰“åŒ…"
          fi
          echo "âœ… ros.binè§£åŒ…å®Œæˆï¼ˆå¿½ç•¥éè‡´å‘½è­¦å‘Šï¼‰"

      - name: æŒ‰å‚æ•°æ‰“åŒ…Squashfsï¼ˆå…¼å®¹æ— rootfsæƒ…å†µï¼‰
        run: |
          # è‹¥è§£åŒ…å‡ºrootfsåˆ™æ‰“åŒ…ï¼Œå¦åˆ™ç”¨åŸå›ºä»¶é‡å»º
          if [ -d "ros.bin.extracted/rootfs" ]; then
            cd ros.bin.extracted/rootfs
            sudo mksquashfs . ../rootfs-new.squashfs -comp $SQSH_COMP -b $SQSH_BLOCK -no-xattrs -preserve-permissions -all-root -noappend
            cd ../../
          else
            # æ— rootfsåˆ™ç›´æ¥å¤åˆ¶åŸå›ºä»¶ä¸ºä¸´æ—¶æ–‡ä»¶
            cp ./ros.bin ./ros.bin.extracted/rootfs-new.squashfs
          fi
          echo "âœ… Squashfsæ‰“åŒ…å®Œæˆ"

      - name: é‡å»ºå›ºä»¶å¤´éƒ¨ï¼ˆç»å¯¹è·¯å¾„æ‰§è¡Œbuildè„šæœ¬ï¼‰
        run: |
          FMK_PATH=$(pwd)/fmk_tool
          if [ -d "ros.bin.extracted" ]; then
            cd ros.bin.extracted
            sudo $FMK_PATH/build-firmware.sh . || true
            cd ../
          fi
          # ç”¨mkimageç”Ÿæˆæœ€ç»ˆå›ºä»¶
          sudo mkimage -A $IMAGE_ARCH -O linux -T kernel -C $IMAGE_COMP -a $IMAGE_ADDR -e $IMAGE_ENTRY -n "$IMAGE_NAME" -d ros.bin.extracted/rootfs-new.squashfs final_fw.bin
          sudo truncate -s $SQSH_SIZE final_fw.bin
          echo "âœ… å›ºä»¶é‡å»ºå®Œæˆ"

      - name: éªŒè¯å¹¶ä¸Šä¼ 
        run: |
          ls -lh final_fw.bin ros.bin
          echo "ğŸ‰ å¤„ç†å®Œæˆï¼final_fw.bin å·²ç”Ÿæˆ"
        uses: actions/upload-artifact@v4
        with:
          name: Ros_Bin_Final
          path: final_fw.bin
          retention-days: 30
