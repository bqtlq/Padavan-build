- name: 精准解包潘多拉固件（基于binwalk偏移）
  run: |
    mkdir -p firmware_split rootfs
    # 1. 分离uImage头部（0x0开始，64字节，对应binwalk的header size: 64 bytes）
    dd if=PandoraBox.bin of=firmware_split/uimage_header.bin bs=1 count=64 2>/dev/null
    # 2. 提取Squashfs文件系统（从0x162FAA偏移开始，跳过头部和内核）
    dd if=PandoraBox.bin of=firmware_split/rootfs.squashfs bs=1 skip=$((0x162FAA)) 2>/dev/null
    # 3. 验证Squashfs镜像有效性
    file firmware_split/rootfs.squashfs || { echo "Squashfs镜像无效"; exit 1; }
    # 4. 解包到rootfs目录
    unsquashfs -d rootfs firmware_split/rootfs.squashfs || { echo "解包失败"; exit 1; }
    ls -l rootfs/  # 确认解包成功

- name: 重新打包+合并固件（保留原头部）
  run: |
    # 1. 打包新的Squashfs根文件系统（参数与原固件一致：xz压缩+256K块）
    mksquashfs rootfs/ firmware_split/new_rootfs.squashfs -comp xz -b 262144 -noappend -all-root -processors 2
    # 2. 合并uImage头部+新根文件系统（必须按原顺序，否则无法刷机）
    cat firmware_split/uimage_header.bin firmware_split/new_rootfs.squashfs > Modified_PandoraBox.bin
    # 3. 验证最终固件
    file Modified_PandoraBox.bin  # 应显示"uImage header"
    ls -l Modified_PandoraBox.bin