name: FMK官方规范版（解包+打包，潘多拉最终稳定版）
on:
  workflow_dispatch:  # 手动触发
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装官方要求依赖
        run: |
          sudo apt update -y
          # 严格按官方README要求安装依赖
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev \
            binwalk squashfs-tools u-boot-tools mtd-utils file wget
          echo "=== 官方依赖安装完成 ==="

      - name: 下载FMK（官方仓库）
        run: |
          echo "=== 下载官方FMK工具 ==="
          git clone https://github.com/rampageX/firmware-mod-kit.git fmk
          cd fmk
          # 官方建议：更新子模块（如果有的话）
          git submodule update --init --recursive 2>/dev/null || true
          cd ../
          echo "=== FMK下载完成 ==="

      - name: 编译FMK（官方标准流程）
        run: |
          echo "=== 按官方说明编译FMK ==="
          cd fmk/src
          make clean && make
          cd ../../
          # 验证编译结果（检查核心脚本是否存在）
          if [ ! -f "fmk/extract-firmware.sh" ] || [ ! -f "fmk/build-firmware.sh" ]; then
            echo "ERROR: FMK编译失败，核心脚本缺失！"
            exit 1
          fi
          echo "=== FMK编译完成 ==="

      - name: 自动下载潘多拉K1固件
        run: |
          echo "=== 下载固件 ==="
          wget -O PandoraBox.bin \
            http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ralink-mt7620-phicomm-k1-2018-12-31-git-4b6a3d5ca-squashfs-sysupgrade.bin \
            --timeout=30 --tries=3 || { echo "固件下载失败"; exit 1; }
          
          ls -lh PandoraBox.bin
          file PandoraBox.bin
          echo "=== 固件准备完成 ==="

      - name: 按官方用法解包（核心修正）
        run: |
          echo "=== 按官方说明清理+解包 ==="
          # 官方用法：extract-firmware.sh <firmware> [output-dir]（支持可选输出目录）
          sudo rm -rf fmk_work 2>/dev/null
          ./fmk/extract-firmware.sh PandoraBox.bin fmk_work
          
          # 验证解包成功（官方强调rootfs目录必须存在）
          if [ ! -d "fmk_work/rootfs" ] || [ ! -f "fmk_work/firmware.info" ]; then
            echo "ERROR: FMK解包失败（不符合官方输出规范）！"
            ls -la fmk_work/
            exit 1
          fi
          echo "✅ 按官方用法解包完成"
          cat fmk_work/firmware.info  # 输出官方生成的固件信息，确认识别正确

      - name: 按官方用法打包（核心修正）
        run: |
          echo "=== 按官方说明打包 ==="
          # 官方用法：build-firmware.sh <input-dir> [output-firmware]（输入目录在前，输出文件在后）
          ./fmk/build-firmware.sh fmk_work Modified_PandoraBox_K1_Original.bin
          
          # 验证打包成功
          if [ ! -f "Modified_PandoraBox_K1_Original.bin" ]; then
            echo "ERROR: 按官方用法打包失败！"
            exit 1
          fi
          echo "✅ 按官方用法打包完成"

      - name: 官方标准验证
        run: |
          echo "=== 原固件 vs 官方打包固件 对比 ==="
          ls -lh PandoraBox.bin Modified_PandoraBox_K1_Original.bin
          ORIG_SIZE=$(stat -c%s "PandoraBox.bin")
          NEW_SIZE=$(stat -c%s "Modified_PandoraBox_K1_Original.bin")
          DIFF=$((NEW_SIZE - ORIG_SIZE))
          echo "大小差异：$DIFF 字节（官方允许±200KB内）"
          
          # 验证固件格式（官方要求必须识别为原固件格式）
          file Modified_PandoraBox_K1_Original.bin
          if ! file Modified_PandoraBox_K1_Original.bin | grep -E "TRX|uImage"; then
            echo "ERROR: 打包固件格式不符合官方要求！"
            exit 1
          fi
          echo "✅ 所有官方规范验证通过"

      - name: 上传官方规范版固件
        uses: actions/upload-artifact@v4
        with:
          name: PandoraBox_K1_FMK_Official
          path: |
            Modified_PandoraBox_K1_Original.bin
            fmk_work/firmware.info  # 上传官方固件信息文件，方便核对
          retention-days: 30
