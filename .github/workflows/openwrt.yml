name: Ros_Bin_Auto_Trigger
on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/openwrt.yml'
      - '.github/workflows/ros.bin'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£…å¿…éœ€å·¥å…·ï¼ˆå«ä¿®å¤ä¾èµ–ï¼‰
        run: sudo apt update -y && sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools u-boot-tools binwalk wget flex bison libssl-dev

      - name: å½»åº•æ¸…ç†æ®‹ç•™
        run: sudo rm -rf fmk* fmk_ros_only* ros.extracted ros.bin.extracted final_fw.bin 2>/dev/null

      - name: å…‹éš†FMKå·¥å…·å¹¶ç¼–è¯‘
        run: |
          git clone --depth 1 https://github.com/rampageX/firmware-mod-kit.git fmk_ros_only
          cd fmk_ros_only/src
          sudo make clean && sudo make || { echo "ERROR: FMKç¼–è¯‘å¤±è´¥"; exit 1; }
          cd ../../ && chmod +x fmk_ros_only/*.sh

      - name: å®šä¹‰å›ºä»¶æ–‡ä»¶åï¼ˆåŒ¹é…ä¸Šä¼ çš„ros.binï¼‰
        run: echo "FW_FILE=ros.bin" >> $GITHUB_ENV

      - name: æ£€æŸ¥å¹¶å¤åˆ¶å›ºä»¶ï¼ˆä».github/workflows/ç›®å½•è¯»å–ï¼‰
        run: |
          FW_PATH=".github/workflows/$FW_FILE"
          if [ -f "$FW_PATH" ]; then
            cp $FW_PATH ./$FW_FILE
            echo "âœ… æˆåŠŸæ‰¾åˆ°å¹¶å¤åˆ¶å›ºä»¶ï¼š$FW_PATH"
          else
            echo "ERROR: æœªæ‰¾åˆ°$FW_PATHï¼Œè¯·ç¡®è®¤å›ºä»¶åœ¨.github/workflows/ç›®å½•ä¸‹"
            exit 1
          fi

      - name: è‡ªåŠ¨æ‰«æå›ºä»¶å‚æ•°ï¼ˆé€‚é…æ½˜å¤šæ‹‰å›ºä»¶çš„mkimageè¾“å‡ºæ ¼å¼ï¼‰
        run: |
          set +e # ä¸´æ—¶å…³é—­ä¸¥æ ¼æ¨¡å¼ï¼Œé¿å…éå…³é”®å‘½ä»¤å¤±è´¥å¯¼è‡´é€€å‡º
          # åˆå§‹åŒ–é»˜è®¤å‚æ•°ï¼ˆä¼˜å…ˆä¿è¯å˜é‡éç©ºï¼‰
          IMAGE_ARCH="mips"
          IMAGE_ADDR="0x80000000"
          IMAGE_ENTRY="0x80000000"
          IMAGE_COMP="lzma"
          SQSH_COMP="xz"
          SQSH_BLOCK="262144"

          # è¯»å–mkimageå®Œæ•´è¾“å‡ºå¹¶ä¿å­˜
          MKIMAGE_OUTPUT=$(mkimage -l $FW_FILE 2>/dev/null)
          if [ -n "$MKIMAGE_OUTPUT" ]; then
            # ä»Image Typeæå–æ¶æ„ï¼ˆæ½˜å¤šæ‹‰å›ºä»¶çš„æ¶æ„åœ¨Image Typeä¸­ï¼‰
            IMAGE_ARCH=$(echo "$MKIMAGE_OUTPUT" | grep -i "Image Type" | sed -r 's/.*\(([a-z0-9]+) .*/\1/' | tr '[:upper:]' '[:lower:]')
            # æå–Load Addresså¹¶è¡¥0xå‰ç¼€
            RAW_ADDR=$(echo "$MKIMAGE_OUTPUT" | grep -i "Load Address" | awk '{print $NF}')
            if [ -n "$RAW_ADDR" ]; then
              IMAGE_ADDR="0x$RAW_ADDR"
            fi
            # æå–Entry Pointå¹¶è¡¥0xå‰ç¼€
            RAW_ENTRY=$(echo "$MKIMAGE_OUTPUT" | grep -i "Entry Point" | awk '{print $NF}')
            if [ -n "$RAW_ENTRY" ]; then
              IMAGE_ENTRY="0x$RAW_ENTRY"
            fi
            # æå–å‹ç¼©æ ¼å¼ï¼ˆä»Image Typeä¸­ï¼‰
            IMAGE_COMP=$(echo "$MKIMAGE_OUTPUT" | grep -i "Image Type" | sed -r 's/.*\(([a-z0-9]+) compressed\).*/\1/' | tr '[:upper:]' '[:lower:]')
          fi
          set -e # æ¢å¤ä¸¥æ ¼æ¨¡å¼

          # æ‰«æSquashfså‚æ•°ï¼ˆä¿®å¤å­—ç¬¦æ±¡æŸ“+å…¼å®¹sedæ­£åˆ™ï¼‰
          if binwalk $FW_FILE | grep -i "Squashfs filesystem" 2>/dev/null; then
            # æå–å‹ç¼©æ ¼å¼
            SQSH_COMP_LINE=$(binwalk $FW_FILE | grep -i "Squashfs filesystem" | grep -i "compression")
            if [ -n "$SQSH_COMP_LINE" ]; then
              SQSH_COMP=$(echo $SQSH_COMP_LINE | sed -r 's/.*compression: *([a-z0-9]+).*/\1/' | tr -d ' ')
            fi
            # æå–å—å¤§å°
            SQSH_BLOCK_LINE=$(binwalk $FW_FILE | grep -i "Squashfs filesystem" | grep -i "blocksize")
            if [ -n "$SQSH_BLOCK_LINE" ]; then
              SQSH_BLOCK=$(echo $SQSH_BLOCK_LINE | sed -r 's/.*blocksize: *([0-9]+).*/\1/' | tr -d ' ')
            fi
          fi

          # æœ€ç»ˆå‚æ•°æ ¡éªŒï¼ˆç¡®ä¿å…³é”®å‚æ•°æœ‰æ•ˆï¼‰
          IMAGE_ARCH=${IMAGE_ARCH:-"mips"}
          IMAGE_ADDR=${IMAGE_ADDR:-"0x80000000"}
          IMAGE_ENTRY=${IMAGE_ENTRY:-"0x80000000"}
          IMAGE_COMP=${IMAGE_COMP:-"lzma"}
          SQSH_COMP=${SQSH_COMP:-"xz"}
          SQSH_BLOCK=${SQSH_BLOCK:-"262144"}

          # è¾“å‡ºå‚æ•°ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
          echo "ğŸ“Œ å›ºä»¶å‚æ•°ï¼š"
          echo "æ¶æ„ï¼š$IMAGE_ARCH | åŠ è½½åœ°å€ï¼š$IMAGE_ADDR | å…¥å£åœ°å€ï¼š$IMAGE_ENTRY | å†…æ ¸å‹ç¼©ï¼š$IMAGE_COMP"
          echo "æ–‡ä»¶ç³»ç»Ÿå‹ç¼©ï¼š$SQSH_COMP | å—å¤§å°ï¼š$SQSH_BLOCK"

          # å­˜å…¥ç¯å¢ƒå˜é‡ï¼ˆå¼ºåˆ¶å†™å…¥ï¼Œé¿å…æƒé™é—®é¢˜ï¼‰
          echo "IMAGE_ARCH=$IMAGE_ARCH" >> $GITHUB_ENV
          echo "IMAGE_ADDR=$IMAGE_ADDR" >> $GITHUB_ENV
          echo "IMAGE_ENTRY=$IMAGE_ENTRY" >> $GITHUB_ENV
          echo "IMAGE_COMP=$IMAGE_COMP" >> $GITHUB_ENV
          echo "SQSH_COMP=$SQSH_COMP" >> $GITHUB_ENV
          echo "SQSH_BLOCK=$SQSH_BLOCK" >> $GITHUB_ENV

      - name: è‡ªåŠ¨è§£åŒ…ros.bin
        run: |
          sudo ./fmk_ros_only/extract-firmware.sh $FW_FILE
          if [ -d "$FW_FILE.extracted/rootfs" ]; then
            mv $FW_FILE.extracted ros.extracted
          elif [ -d "fmk/rootfs" ]; then
            mv fmk ros.extracted
          else
            echo "ERROR: å›ºä»¶è§£åŒ…å¤±è´¥ï¼Œç¡®è®¤æ˜¯uImage+Squashfsæ ¼å¼ï¼"
            exit 1
          fi

      - name: è‡ªåŠ¨æ‰“åŒ…rootfs
        run: |
          cd ros.extracted/rootfs
          sudo mksquashfs . ../rootfs.sqsh -b $SQSH_BLOCK -comp $SQSH_COMP -no-xattrs -all-root
          cd ../../

      - name: é‡å»ºuImageå¤´éƒ¨ï¼ˆåŒ¹é…æ½˜å¤šæ‹‰å›ºä»¶çš„çœŸå®å‚æ•°ï¼‰
        run: |
          sudo mkimage -A $IMAGE_ARCH -O linux -T kernel -C $IMAGE_COMP -a $IMAGE_ADDR -e $IMAGE_ENTRY -n "PandoraBox_ROS" -d ros.extracted/rootfs.sqsh final_fw.bin

      - name: ä¸Šä¼ ä¿®æ”¹åçš„å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: Modified_ROS_Firmware
          path: final_fw.bin
          retention-days: 30
