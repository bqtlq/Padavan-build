name: 解包删除PPPoE并重新打包PandoraBox固件

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  modify-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装依赖工具
        run: |
          sudo apt update -y
          sudo apt install -y binwalk squashfs-tools build-essential  # 仅保留系统原生工具
          # 验证工具安装
          mksquashfs -version
          unsquashfs -version

      - name: 加载PandoraBox.bin固件
        run: |
          cp .github/workflows/PandoraBox.bin ./PandoraBox.bin
          ls -l ./PandoraBox.bin

      - name: 解包PandoraBox固件
        run: |
          binwalk -Me PandoraBox.bin
          ls -l _PandoraBox.bin.extracted/
          cd _PandoraBox.bin.extracted/squashfs-root || exit 1
          pwd

      - name: 删除PPPoE组件
        run: |
          cd _PandoraBox.bin.extracted/squashfs-root || exit 1
          # 删除PPPoE二进制/配置/脚本
          rm -rf ./usr/sbin/pppoe* ./usr/bin/pppoe*
          rm -f ./etc/config/pppoe ./etc/ppp/peers/pppoe* ./etc/init.d/pppoe
          # 清理opkg状态记录
          sed -i '/Package: ppp-mod-pppoe/,/^$/d' ./usr/lib/opkg/status 2>/dev/null
          sed -i '/Package: pppoe/,/^$/d' ./usr/lib/opkg/status 2>/dev/null
          # 清理残留文件
          find . -name "*pppoe*" -exec rm -rf {} \; 2>/dev/null
          cd ../../

      - name: 重新打包squashfs镜像
        run: |
          cd _PandoraBox.bin.extracted/
          # 用系统工具打包，参数与潘多拉固件一致（lzma+256K块）
          mksquashfs squashfs-root new_rootfs.bin -comp lzma -b 262144 -noappend -all-root
          ls -l new_rootfs.bin
          cd ../

      - name: 合并生成最终固件
        run: |
          # 分离原固件头部（前4096字节为bootloader）
          dd if=PandoraBox.bin of=bootloader.bin bs=1 count=4096
          # 合并头部+新根文件系统
          cat bootloader.bin _PandoraBox.bin.extracted/new_rootfs.bin > Modified_PandoraBox.bin
          # 校验固件结构
          binwalk Modified_PandoraBox.bin
          ls -l Modified_PandoraBox.bin

      - name: 上传修改后的固件
        uses: actions/upload-artifact@v4
        with:
          name: Modified_PandoraBox_NoPPPoE
          path: ./Modified_PandoraBox.bin
          retention-days: 30