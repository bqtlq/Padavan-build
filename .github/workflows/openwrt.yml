name: Ros_Bin_Auto_Trigger
on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£…å¿…éœ€å·¥å…·
        run: sudo apt update -y && sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools u-boot-tools binwalk wget

      - name: å½»åº•æ¸…ç†æ®‹ç•™
        run: sudo rm -rf fmk* fmk_ros_only* ros.extracted ros.bin.extracted final_fw.bin 2>/dev/null

      - name: å…‹éš†FMKï¼ˆå”¯ä¸€ç›®å½•åï¼‰
        run: git clone --depth 1 https://github.com/rampageX/firmware-mod-kit.git fmk_ros_only && cd fmk_ros_only/src && sudo make clean && sudo make && cd ../../ && chmod +x fmk_ros_only/*.sh

      - name: å¤åˆ¶å›ºä»¶æ–‡ä»¶ï¼ˆå…¼å®¹ä»»æ„binå›ºä»¶ï¼Œåªéœ€æ›¿æ¢ros.binï¼‰
        run: |
          # æŠŠros.binæ¢æˆä½ æ–°å›ºä»¶çš„æ–‡ä»¶åå³å¯ï¼Œæ¯”å¦‚new_fw.bin
          FW_FILE="ros.bin"
          if [ -f ".github/workflows/$FW_FILE" ]; then
            cp .github/workflows/$FW_FILE ./$FW_FILE
            echo "âœ… åŠ è½½å›ºä»¶ï¼š$FW_FILE"
          else
            echo "ERROR: æœªæ‰¾åˆ°$FW_FILEï¼Œè¯·ç¡®è®¤æ–‡ä»¶åœ¨.github/workflows/ç›®å½•"
            exit 1
          fi

      - name: è‡ªåŠ¨æ‰«æå‚æ•°+é»˜è®¤å…œåº•ï¼ˆé€‚é…ä»»æ„å›ºä»¶ï¼‰
        run: |
          FW_FILE="ros.bin" # å’Œä¸Šé¢çš„å›ºä»¶æ–‡ä»¶åä¿æŒä¸€è‡´
          # æ‰«æuImageå¤´éƒ¨å‚æ•°ï¼Œå¤±è´¥åˆ™ç”¨é»˜è®¤
          if mkimage -l $FW_FILE 2>/dev/null; then
            IMAGE_ARCH=$(mkimage -l $FW_FILE | grep -i "Architecture" | awk '{print $3}' | sed 's/://g')
            IMAGE_ADDR=$(mkimage -l $FW_FILE | grep -i "Data Address" | awk '{print $4}')
            IMAGE_COMP=$(mkimage -l $FW_FILE | grep -i "Compression" | awk '{print $3}' | sed 's/://g')
          else
            IMAGE_ARCH="mips"
            IMAGE_ADDR="0x80000000"
            IMAGE_COMP="lzma"
          fi
          # æ‰«æSquashfså‚æ•°ï¼Œå¤±è´¥åˆ™ç”¨é»˜è®¤
          if binwalk -E $FW_FILE | grep -i "Squashfs filesystem" 2>/dev/null; then
            SQSH_COMP=$(binwalk -E $FW_FILE | grep -i "Squashfs filesystem" | awk -F ', ' '{for(i=1;i<=NF;i++) if($i ~ /compression:/) print substr($i,12)}')
            SQSH_BLOCK=$(binwalk -E $FW_FILE | grep -i "Squashfs filesystem" | awk -F ', ' '{for(i=1;i<=NF;i++) if($i ~ /blocksize:/) print substr($i,11) | sed 's/ bytes//g'}')
          else
            SQSH_COMP="xz"
            SQSH_BLOCK="262144"
          fi
          # å›ºä»¶ä½“ç§¯å¿…å–çœŸå®å€¼
          SQSH_SIZE=$(stat -c %s $FW_FILE)
          # ç©ºå€¼äºŒæ¬¡å…œåº•ï¼ˆé˜²æ­¢æ‰«æç»“æœä¸ºç©ºï¼‰
          IMAGE_ARCH=${IMAGE_ARCH:-"mips"}
          IMAGE_ADDR=${IMAGE_ADDR:-"0x80000000"}
          IMAGE_COMP=${IMAGE_COMP:-"lzma"}
          SQSH_COMP=${SQSH_COMP:-"xz"}
          SQSH_BLOCK=${SQSH_BLOCK:-"262144"}
          # è¾“å‡ºæ‰«æç»“æœï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
          echo "ğŸ“Œ æœ€ç»ˆå‚æ•°ï¼š"
          echo "æ¶æ„ï¼š$IMAGE_ARCH | åŠ è½½åœ°å€ï¼š$IMAGE_ADDR | å†…æ ¸å‹ç¼©ï¼š$IMAGE_COMP"
          echo "æ–‡ä»¶ç³»ç»Ÿå‹ç¼©ï¼š$SQSH_COMP | å—å¤§å°ï¼š$SQSH_BLOCK | å›ºä»¶ä½“ç§¯ï¼š$SQSH_SIZE"
          # å­˜å…¥ç¯å¢ƒå˜é‡
          echo "IMAGE_ARCH=$IMAGE_ARCH" >> $GITHUB_ENV
          echo "IMAGE_ADDR=$IMAGE_ADDR" >> $GITHUB_ENV
          echo "IMAGE_COMP=$IMAGE_COMP" >> $GITHUB_ENV
          echo "SQSH_COMP=$SQSH_COMP" >> $GITHUB_ENV
          echo "SQSH_BLOCK=$SQSH_BLOCK" >> $GITHUB_ENV
          echo "SQSH_SIZE=$SQSH_SIZE" >> $GITHUB_ENV
          echo "FW_FILE=$FW_FILE" >> $GITHUB_ENV

      - name: è‡ªåŠ¨è§£åŒ…ï¼ˆå…¼å®¹ä»»æ„å›ºä»¶ï¼‰
        run: |
          sudo ./fmk_ros_only/extract-firmware.sh $FW_FILE
          if [ -d "$FW_FILE.extracted/rootfs" ]; then
            mv $FW_FILE.extracted ros.extracted
          elif [ -d "fmk/rootfs" ]; then
            mv fmk ros.extracted
          else
            echo "ERROR: å›ºä»¶è§£åŒ…å¤±è´¥ï¼ŒéuImage+Squashfsæ¶æ„ï¼"
            exit 1
          fi

      - name: è‡ªåŠ¨æ‰“åŒ…ï¼ˆç”¨æ‰«æçš„çœŸå®å‚æ•°ï¼‰
        run: |
          cd ros.extracted/rootfs
          sudo mksquashfs . ../rootfs.sqsh -b $SQSH_BLOCK -comp $SQSH_COMP -no-xattrs -all-root
          cd ../../

      - name: è‡ªåŠ¨é‡å»ºå¯åŠ¨å¤´éƒ¨ï¼ˆåŒ¹é…æ‰«æå‚æ•°ï¼‰
        run: |
          sudo mkimage -A $IMAGE_ARCH -O linux -T kernel -C $IMAGE_COMP -a $IMAGE_ADDR -e $IMAGE_ADDR -d ros.extracted/rootfs.sqsh final_fw.bin
          sudo truncate -s $SQSH_SIZE final_fw.bin

      - name: ä¸Šä¼ å›ºä»¶ï¼ˆZIPå‹ç¼©ï¼Œæ— è­¦å‘Šï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: Auto_Trigger_Working_Firmware
          path: final_fw.bin
          retention-days: 30
