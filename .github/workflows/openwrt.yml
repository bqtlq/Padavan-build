name: FMK_Old_Script_Stable（Padavan专用）
on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装官方依赖
        run: |
          sudo apt update -y
          # 无需unzip，恢复tar.gz依赖（zlib1g-dev已包含解压支持）
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools u-boot-tools binwalk wget
          echo "✅ 依赖安装完成（适配tar.gz格式）"

      - name: 终极清理（含新包残留）
        run: |
          # 清理新链接对应的tar.gz包及旧文件
          sudo rm -rf fmk firmware-mod-kit final_fw.bin ros.bin padavan_source fmk_099.tar.gz 2>/dev/null
          echo "✅ 残留清理完成"

      - name: 下载FMK官方tar.gz包（新链接，含old脚本）
        run: |
          # 使用用户提供的Google Code归档新链接
          wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/firmware-mod-kit/fmk_099.tar.gz
          # 解压tar.gz包（-zxvf适配gzip压缩，-C指定目录避免混乱）
          tar -zxvf fmk_099.tar.gz -C ./
          # 验证解压后的目录名（Google Code旧包默认目录为firmware-mod-kit-0.99，若不同需调整）
          if [ -d "firmware-mod-kit-0.99" ]; then
            mv firmware-mod-kit-0.99 fmk
          elif [ -d "firmware-mod-kit" ]; then
            mv firmware-mod-kit fmk  # 兼容可能的目录名差异
          else
            echo "ERROR: 解压后未找到FMK核心目录"
            exit 1
          fi
          # 删除tar.gz包节省空间
          rm -f fmk_099.tar.gz
          echo "✅ 新链接包下载解压完成，含old-extract.sh/old-build.sh"

      - name: 给old脚本加执行权限
        run: |
          cd fmk
          chmod +x old-extract.sh old-build.sh
          chmod +x src/*/*.sh
          cd ../
          echo "✅ old脚本权限设置完成"

      - name: 复制Padavan固件
        run: |
          FW_NAME="ros.bin"
          if [ -f ".github/workflows/$FW_NAME" ]; then
            cp .github/workflows/$FW_NAME ./$FW_NAME
            chmod 644 ./$FW_NAME
            echo "✅ 加载固件：$FW_NAME"
          else
            echo "ERROR: 未找到$FW_NAME，请确认文件在.github/workflows/目录"
            exit 1
          fi
          echo "FW_NAME=$FW_NAME" >> $GITHUB_ENV

      - name: 用官方old-extract.sh解包（兼容Padavan）
        run: |
          sudo ./fmk/old-extract.sh ./$FW_NAME
          if [ ! -d "fmk/rootfs" ]; then
            echo "ERROR: 解包失败，可能固件非Padavan/uImage格式"
            exit 1
          fi
          echo "✅ old脚本解包完成"

      - name: 复制解包后源码（完整保留）
        run: |
          mkdir -p padavan_source
          sudo cp -r fmk/rootfs fmk/kernel fmk/squashfs-root fmk/*.img padavan_source/ 2>/dev/null
          sudo chmod -R 755 padavan_source
          echo "✅ 源码已复制到 padavan_source 目录"
          ls -l padavan_source

      - name: 上传解包后完整源码
        uses: actions/upload-artifact@v4
        with:
          name: Padavan_Unpacked_Source
          path: padavan_source/
          retention-days: 30

      - name: 用官方old-build.sh打包（确保开机）
        run: |
          cd fmk
          sudo ./old-build.sh
          cd ../
          cp fmk/firmware.bin final_fw.bin
          echo "✅ 固件打包完成"

      - name: 上传可开机固件
        uses: actions/upload-artifact@v4
        with:
          name: Padavan_Bootable_Firmware
          path: final_fw.bin
          retention-days: 30
