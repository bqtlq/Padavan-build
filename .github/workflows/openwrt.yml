name: Ros_Bin_Auto_Run_Final
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装工具
        run: sudo apt update -y && sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools u-boot-tools binwalk wget

      - name: 彻底清理残留
        run: sudo rm -rf fmk* fmk_ros_only* ros.extracted ros.bin.extracted final_fw.bin 2>/dev/null

      - name: 克隆FMK（唯一目录名）
        run: git clone --depth 1 https://github.com/rampageX/firmware-mod-kit.git fmk_ros_only && cd fmk_ros_only/src && sudo make clean && sudo make && cd ../../ && chmod +x fmk_ros_only/*.sh

      - name: 复制ros.bin
        run: cp .github/workflows/ros.bin ./ros.bin || echo "ros.bin已存在"

      - name: 硬指定参数（避免为空，自动适配潘多拉）
        run: |
          # 直接用潘多拉K1已知有效参数，不用扫描
          echo "IMAGE_ARCH=mips" >> $GITHUB_ENV
          echo "IMAGE_ADDR=0x80000000" >> $GITHUB_ENV
          echo "SQSH_COMP=xz" >> $GITHUB_ENV  # 固定xz压缩，原固件默认
          echo "SQSH_BLOCK=262144" >> $GITHUB_ENV  # 固定256K块大小
          echo "SQSH_SIZE=$(stat -c %s ros.bin)" >> $GITHUB_ENV

      - name: 解包（自动兼容目录）
        run: |
          sudo ./fmk_ros_only/extract-firmware.sh ros.bin
          if [ -d "fmk/rootfs" ]; then
            mv fmk ros.extracted
          elif [ -d "ros.bin.extracted/rootfs" ]; then
            mv ros.bin.extracted ros.extracted
          fi

      - name: 打包（固定参数，自动运行）
        run: |
          cd ros.extracted/rootfs
          # 明确指定压缩方式，不会再误判参数
          sudo mksquashfs . ../rootfs.sqsh -comp xz -b 262144 -no-xattrs -preserve-permissions -all-root
          cd ../../

      - name: 重建启动头部（自动适配）
        run: sudo mkimage -A mips -O linux -T kernel -C lzma -a 0x80000000 -e 0x80000000 -d ros.extracted/rootfs.sqsh final_fw.bin && sudo truncate -s $SQSH_SIZE final_fw.bin

      - name: 自动上传固件
        uses: actions/upload-artifact@v4
        with:
          name: Ros_Bin_Auto_Working_Firmware
          path: final_fw.bin
          retention-days: 30
