name: Build Padavan-YZ-100A  # 改1：脚本名称，对应你的路由器型号

# 精简触发条件：仅手动触发（workflow_dispatch）+ 标签触发，避免误编译
on: 
  workflow_dispatch:  # 手动触发（推荐，想编译时在GitHub点一下即可）
  push:
    tags:
    - 'v*'  # 推送v开头的标签时触发（可选）

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id  # 仅仓库所有者触发

    steps:
    - name: Checkout
      uses: actions/checkout@master

    - name: 初始化编译环境（最小依赖）
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update -y
        # 只保留编译Padavan的核心依赖，删除非必要包
        sudo apt-get -y install unzip libtool-bin curl cmake gperf gawk flex bison \
        cpio git gettext automake autopoint texinfo build-essential pkg-config \
        zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev

    - name: 克隆源码（固定3.4内核，YZ-100A适配）
      run: |
        # YZ-100A（MT7620）仅支持3.4内核，直接克隆对应源码
        git clone --depth=1 https://github.com/bqtlq/rt-n56u.git /opt/rt-n56u
        cd /opt/rt-n56u/toolchain-mipsel
        sh dl_toolchain.sh  # 下载编译工具链
        mkdir -p /opt/images/  # 创建固件输出目录

    - name: 编译固件（极致精简，适配YZ-100A+静态IP双WAN+SSH必生效）
      env:
        TNAME: YZ-100A  # 改2：核心模板名，必须和源码configs/templates/下的YZ-100A.config一致
      run: |
        cd /opt/rt-n56u/trunk
        # 检查模板文件是否存在，不存在则终止（确保型号正确）
        if [ ! -f configs/templates/$TNAME.config ] ; then
          echo "错误：未找到 $TNAME.config 模板文件！请确认源码templates目录下的文件名"
          exit 1
        fi
        cp -f configs/templates/$TNAME.config .config

        # ========== 核心精简：删除所有非必要功能配置 ==========
        # 先清空所有可选功能配置项
        sed -i '/CONFIG_FIRMWARE_INCLUDE_/d' .config

        # ========== 仅保留基础功能（适配静态IP双WAN+SSH必生效） ==========
        # 基础网络/SSH/OpenSSL（静态IP双WAN+SSH必需）
        echo "CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y" >> .config  # SSH依赖的加密库（必需）
        echo "CONFIG_FIRMWARE_INCLUDE_DROPBEAR=y" >> .config    # 轻量SSH（唯一开启，0.3MB，稳定）
        echo "CONFIG_FIRMWARE_INCLUDE_DNSMASQ=y" >> .config     # DNS解析（静态IP必需）
        echo "CONFIG_FIRMWARE_INCLUDE_DHCPD=y" >> .config       # LAN侧DHCP（给终端分配IP，必需）
        echo "CONFIG_FIRMWARE_INCLUDE_VLAN=y" >> .config        # VLAN功能（双WAN必需，之前漏了！）

        # ========== 砍掉你用不到的功能（核心精简） ==========
        echo "CONFIG_FIRMWARE_INCLUDE_PPPOE=n" >> .config       # 你用静态IP，无需PPPoE
        echo "CONFIG_FIRMWARE_INCLUDE_IPTABLES=n" >> .config    # 你无需防火墙，关闭
        echo "CONFIG_FIRMWARE_INCLUDE_OPENSSH=n" >> .config     # 关闭重型OpenSSH，避免冲突

        # ========== 开始编译 ==========
        sudo ./clear_tree  # 清理编译缓存
        sudo ./build_firmware_modify $TNAME 0  # 编译固件（用YZ-100A模板）
        # 关键修改1：确认.trx文件路径，移动时保留原文件名（避免重命名导致识别问题）
        sudo find /opt/rt-n56u/trunk/images -name "*.trx" -exec cp -f {} /opt/images/ \;
        # 可选：输出文件列表，确认.trx已移动成功
        ls -l /opt/images/

    - name: 上传编译好的固件（直接输出.trx文件，非压缩包）
      uses: actions/upload-artifact@v4  # 关键修改2：升级到v4版本，默认不压缩单个文件
      if: always()  # 即使编译失败也上传日志（方便排查）
      with:
        name: Padavan-YZ-100A  # 改3：上传的固件包名称，对应你的路由器型号
        path: /opt/images/*.trx  # 关键修改3：只上传.trx文件，精准匹配
        if-no-files-found: error  # 没有.trx文件则报错，提示编译失败
        retention-days: 30  # 固件保留30天，可按需调整
