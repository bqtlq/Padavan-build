name: 纯解包+直接打包（优化版，贴合文章思路）
on:
  workflow_dispatch:  # 手动触发
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  verify-firmware-process:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装核心依赖工具（文章推荐工具集）
        run: |
          sudo apt update -y
          # 完全贴合文章推荐工具：binwalk+squashfs-tools+u-boot-tools+dd（系统自带）
          sudo apt install -y binwalk squashfs-tools build-essential mtd-utils file wget u-boot-tools
          echo "=== 工具版本验证 ==="
          mksquashfs -version | head -n1
          unsquashfs -version | head -n1
          mkimage -V | head -n1

      - name: 自动下载潘多拉K1固件
        run: |
          echo "=== 开始下载固件 ==="
          wget -O PandoraBox.bin \
            http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ralink-mt7620-phicomm-k1-2018-12-31-git-4b6a3d5ca-squashfs-sysupgrade.bin \
            --timeout=30 \
            --tries=3 || { echo "ERROR: 固件下载失败"; exit 1; }
          
          echo "=== 原固件信息（贴合文章结构分析） ==="
          ls -lh PandoraBox.bin
          ORIGINAL_SIZE=$(stat -c%s "PandoraBox.bin")
          echo "原固件大小：$ORIGINAL_SIZE 字节"
          # 文章强调先分析结构，这里补充binwalk关键输出
          binwalk -x none PandoraBox.bin | grep -E "uImage|Squashfs"
          
          file PandoraBox.bin
          if ! file PandoraBox.bin | grep -q "uImage"; then
            echo "ERROR: 下载的固件不是uImage格式！"
            exit 1
          fi
          echo "✅ 固件下载并验证成功"

      - name: 精准解包（贴合文章分离逻辑）
        run: |
          mkdir -p firmware_split rootfs
          echo "=== 开始精准解包 ==="
          
          UIMAGE_HEADER_SIZE=64
          SQUASHFS_OFFSET=$((0x162FAA))
          
          # 文章核心：分离uImage头部（64字节）
          dd if=PandoraBox.bin of=firmware_split/uimage_header.bin bs=1 count=$UIMAGE_HEADER_SIZE 2>/dev/null
          echo "✅ 已分离uImage头部（$UIMAGE_HEADER_SIZE字节）"
          
          # 分离Squashfs文件系统（文章强调的核心步骤）
          dd if=PandoraBox.bin of=firmware_split/rootfs.squashfs bs=1 skip=$SQUASHFS_OFFSET 2>/dev/null
          if ! file firmware_split/rootfs.squashfs | grep -q "Squashfs filesystem"; then
            echo "ERROR: Squashfs镜像无效！"
            file firmware_split/rootfs.squashfs
            exit 1
          fi
          echo "✅ Squashfs镜像验证有效"
          
          # 解包：保留原文件权限（文章提到避免权限错乱），跳过设备文件
          unsquashfs -n -p 4 -d rootfs firmware_split/rootfs.squashfs || true
          # 补充：修复可能的权限问题（文章隐含的稳定点）
          sudo chown -R root:root rootfs/ 2>/dev/null || true
          
          # 验证解包成功（文章强调核心目录存在）
          if [ ! -d "rootfs/etc" ] || [ ! -d "rootfs/usr" ] || [ ! -d "rootfs/bin" ]; then
            echo "ERROR: 解包失败，核心目录不存在！"
            exit 1
          fi
          echo "✅ Squashfs解包完成（保留原文件权限）"
          ls -l rootfs/ | head -n10

      - name: 重新打包（贴合文章格式要求）
        run: |
          echo "=== 开始重新打包Squashfs ==="
          # 优化点1：保留原文件权限（-preserve-permissions），文章强调避免权限问题
          # 优化点2：添加-no-xattrs，避免扩展属性干扰（老固件兼容）
          mksquashfs rootfs/ firmware_split/new_rootfs.squashfs \
            -comp xz \
            -b 262144 \
            -noappend \
            -all-root \
            -preserve-permissions \  # 新增：保留原文件权限
            -no-xattrs \             # 新增：避免扩展属性干扰
            -processors 2
          
          if [ ! -f "firmware_split/new_rootfs.squashfs" ]; then
            echo "ERROR: 打包失败"
            exit 1
          fi
          echo "✅ Squashfs打包完成"
          ls -lh firmware_split/new_rootfs.squashfs

      - name: 重建uImage头部（文章核心强调步骤）
        run: |
          echo "=== 重建uImage头部并合并固件 ==="
          mkimage \
            -A mips \
            -O linux \
            -T kernel \
            -C lzma \
            -a 0x80000000 \
            -e 0x80000000 \
            -n "MIPS PandoraBox Linux-3.14.79" \
            -d firmware_split/new_rootfs.squashfs \
            Modified_PandoraBox_K1_Original.bin
          
          if [ ! -f "Modified_PandoraBox_K1_Original.bin" ]; then
            echo "ERROR: 固件合并失败"
            exit 1
          fi
          
          # 补充：验证新固件结构（文章提到的完整性检查）
          echo "=== 新固件结构验证（贴合文章要求） ==="
          binwalk -x none Modified_PandoraBox_K1_Original.bin | grep -E "uImage|Squashfs"
          if ! binwalk -x none Modified_PandoraBox_K1_Original.bin | grep -q "Squashfs filesystem"; then
            echo "ERROR: 新固件缺少Squashfs文件系统！"
            exit 1
          fi
          
          echo "=== 原固件 vs 新固件 大小对比 ==="
          ls -lh PandoraBox.bin Modified_PandoraBox_K1_Original.bin
          NEW_SIZE=$(stat -c%s "Modified_PandoraBox_K1_Original.bin")
          ORIGINAL_SIZE=$(stat -c%s "PandoraBox.bin")
          DIFF=$((NEW_SIZE - ORIGINAL_SIZE))
          echo "大小差异：$DIFF 字节（±500KB内均正常）"
          
          echo "✅ 可刷机固件生成完成"

      - name: 上传验证用固件
        uses: actions/upload-artifact@v4
        with:
          name: PandoraBox_K1_Original_Repacked
          path: Modified_PandoraBox_K1_Original.bin
          retention-days: 30
