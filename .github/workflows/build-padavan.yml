name: Build Padavan-RT-N14U

# 精简触发条件：仅手动触发（workflow_dispatch）+ 标签触发，避免误编译
on: 
  workflow_dispatch:  # 手动触发（推荐，想编译时在GitHub点一下即可）
  push:
    tags:
    - 'v*'  # 推送v开头的标签时触发（可选）

jobs:
  build:
    runs-on: ubuntu-18.04
    if: github.event.repository.owner.id == github.event.sender.id  # 仅仓库所有者触发

    steps:
    - name: Checkout
      uses: actions/checkout@master

    - name: 初始化编译环境（最小依赖）
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update -y
        # 只保留编译Padavan的核心依赖，删除非必要包
        sudo apt-get -y install unzip libtool-bin curl cmake gperf gawk flex bison \
        cpio git gettext automake autopoint texinfo build-essential pkg-config \
        zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev

    - name: 克隆源码（固定3.4内核，RT-N14U适配）
      run: |
        # RT-N14U仅支持3.4内核，删除4.4内核判断，直接克隆对应源码
        git clone --depth=1 https://github.com/bqtlq/rt-n56u.git /opt/rt-n56u
        cd /opt/rt-n56u/toolchain-mipsel
        sh dl_toolchain.sh  # 下载编译工具链
        mkdir -p /opt/images/  # 创建固件输出目录

    - name: 编译固件（极致精简，仅保留基础网络功能）
      env:
        TNAME: RT-N14U  # 关键：RT-N14U的模板名（需和configs/templates/下一致）
      run: |
        cd /opt/rt-n56u/trunk
        # 检查模板文件是否存在，不存在则终止
        if [ ! -f configs/templates/$TNAME.config ] ; then
          echo "错误：未找到 $TNAME.config 模板文件！"
          exit 1
        fi
        cp -f configs/templates/$TNAME.config .config

        # ========== 核心精简：删除所有非必要功能配置 ==========
        # 先清空所有可选功能配置项
        sed -i '/CONFIG_FIRMWARE_INCLUDE_/d' .config

        # ========== 仅保留基础功能（适配双WAN需求） ==========
        # 基础网络/SSH/OpenSSL（双WAN必需）
        echo "CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SSHD=y" >> .config  # 保留SSH（方便调试）
        echo "CONFIG_FIRMWARE_INCLUDE_DNSMASQ=y" >> .config  # DNS基础功能
        echo "CONFIG_FIRMWARE_INCLUDE_IPTABLES=y" >> .config  # 防火墙（双WAN必需）
        echo "CONFIG_FIRMWARE_INCLUDE_PPPOE=y" >> .config  # PPPoE拨号（宽带必需）
        echo "CONFIG_FIRMWARE_INCLUDE_DHCPD=y" >> .config  # DHCP服务（双WAN自动获取IP必需）

        # ========== 开始编译 ==========
        sudo ./clear_tree  # 清理编译缓存
        sudo ./build_firmware_modify $TNAME 0  # 编译固件
        sudo mv -f images/*.trx /opt/images/  # 移动固件到输出目录

    - name: 上传编译好的固件
      uses: actions/upload-artifact@master
      if: always()  # 即使编译失败也上传日志（方便排查）
      with:
        name: Padavan-RT-N14U
        path: /opt/images
