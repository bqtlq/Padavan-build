name: Build PandoraBox-phicomm-k1
on:
  push:
    branches: [master] # 仓库当前分支是master，匹配触发
    paths: [".github/workflows/openwrt.yml"] # 仅修改该文件时触发
  workflow_dispatch: # 保留手动触发

jobs:
  build:
    runs-on: ubuntu-latest # 改用github最新支持的ubuntu版本
    steps:
      - name: 删除冗余的ros.bin文件
        run: |
          if [ -f ".github/workflows/ros.bin" ]; then
            rm .github/workflows/ros.bin
            echo "已删除ros.bin冗余文件"
          fi

      - name: 安装编译依赖
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          # 适配ubuntu-latest的依赖包，替换废弃的libssl1.0-dev
          sudo apt install -y build-essential libncurses5-dev zlib1g-dev gawk git libssl-dev wget unzip python2 python3 ocaml-nox help2man texinfo npm golang node-gyp
          # 解决python2环境关联问题
          sudo ln -s /usr/bin/python2 /usr/bin/python || true

      - name: 验证下载链接并下载ImageBuilder
        run: |
          IMG_URL="http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ImageBuilder-ralink-mt7620.Linux-x86_64-2018-12-31-git-4b18a9c6c.tar.xz"
          if wget --spider $IMG_URL; then
            wget $IMG_URL -O pb-imagebuilder.tar.xz
            echo "下载ImageBuilder成功"
          else
            echo "下载链接失效，编译终止"
            exit 1
          fi

      - name: 解压ImageBuilder
        run: tar -Jxvf pb-imagebuilder.tar.xz

      - name: 编译phicomm-k1固件
        run: |
          cd PandoraBox-ImageBuilder-ralink-mt7620.Linux-x86_64-2018-12-31-git-4b18a9c6c
          # 执行编译命令，添加错误捕获
          make image PROFILE="phicomm-k1" PACKAGES=" -dosfsck -luci-i18n-phddns2-zh-cn -mkdosfs" || { echo "固件编译失败"; exit 1; }

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: PandoraBox-phicomm-k1-firmware
          path: ./PandoraBox-ImageBuilder-ralink-mt7620.Linux-x86_64-2018-12-31-git-4b18a9c6c/bin/
          retention-days: 7 # 产物保留7天，可按需调整
