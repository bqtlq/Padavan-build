name: FMK实战版（忽略旧版兼容警告，确保解包打包）
on:
  workflow_dispatch:  # 手动触发
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装依赖
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev \
            binwalk squashfs-tools u-boot-tools mtd-utils file wget
          echo "=== 依赖安装完成 ==="

      - name: 下载并编译FMK
        run: |
          echo "=== 下载FMK ==="
          git clone https://github.com/rampageX/firmware-mod-kit.git fmk
          cd fmk/src
          make clean && make
          cd ../../
          echo "=== FMK编译完成 ==="

      - name: 自动下载潘多拉K1固件
        run: |
          echo "=== 下载固件 ==="
          wget -O PandoraBox.bin \
            http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ralink-mt7620-phicomm-k1-2018-12-31-git-4b6a3d5ca-squashfs-sysupgrade.bin \
            --timeout=30 --tries=3 || { echo "固件下载失败"; exit 1; }
          
          ls -lh PandoraBox.bin
          echo "=== 固件准备完成 ==="

      - name: 解包（忽略旧版警告，只认rootfs）
        run: |
          echo "=== 清理+解包 ==="
          sudo rm -rf fmk_work 2>/dev/null
          # 忽略旧版FMK的语法警告，聚焦解包结果
          ./fmk/extract-firmware.sh PandoraBox.bin fmk_work || true
          
          # 核心验证：只要rootfs存在，就认为解包成功（旧版无firmware.info）
          if [ ! -d "fmk_work/rootfs" ]; then
            echo "ERROR: 真·解包失败，无rootfs目录！"
            ls -la fmk_work/
            exit 1
          fi
          echo "✅ 解包成功（忽略旧版语法警告）"
          ls -l fmk_work/rootfs/ | head -n10

      - name: 打包（实战优先，按官方路径用法）
        run: |
          echo "=== 开始打包 ==="
          # 严格按官方用法：build-firmware.sh <解包目录> <输出固件>
          ./fmk/build-firmware.sh fmk_work Modified_PandoraBox_K1_Original.bin
          
          if [ ! -f "Modified_PandoraBox_K1_Original.bin" ]; then
            echo "ERROR: 打包失败"
            exit 1
          fi
          echo "✅ 打包完成"

      - name: 最终验证（能启动为核心）
        run: |
          echo "=== 固件最终验证 ==="
          ls -lh PandoraBox.bin Modified_PandoraBox_K1_Original.bin
          ORIG_SIZE=$(stat -c%s "PandoraBox.bin")
          NEW_SIZE=$(stat -c%s "Modified_PandoraBox_K1_Original.bin")
          DIFF=$((NEW_SIZE - ORIG_SIZE))
          echo "大小差异：$DIFF 字节（±300KB内均正常）"
          
          # 验证格式：必须包含uImage（潘多拉启动必需）
          file Modified_PandoraBox_K1_Original.bin
          if ! file Modified_PandoraBox_K1_Original.bin | grep -q "uImage"; then
            echo "ERROR: 固件格式异常，无uImage头部！"
            exit 1
          fi
          echo "✅ 固件格式正确，可刷机！"

      - name: 上传可刷机固件
        uses: actions/upload-artifact@v4
        with:
          name: PandoraBox_K1_Final_Working
          path: Modified_PandoraBox_K1_Original.bin
          retention-days: 30
