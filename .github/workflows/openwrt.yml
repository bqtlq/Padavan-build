name: FMK自动解包+打包（潘多拉稳定版，修复目录冲突）
on:
  workflow_dispatch:  # 手动触发
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装依赖（含FMK必需工具）
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev \
            binwalk squashfs-tools u-boot-tools mtd-utils file wget
          echo "=== 工具安装完成 ==="

      - name: 下载并编译Firmware Mod Kit（帖子核心工具）
        run: |
          echo "=== 下载FMK工具 ==="
          git clone https://github.com/rampageX/firmware-mod-kit.git fmk
          cd fmk/src
          # 编译FMK（帖子强调必须编译才能使用）
          make clean && make
          cd ../../
          echo "=== FMK编译完成 ==="

      - name: 自动下载潘多拉K1固件
        run: |
          echo "=== 下载固件 ==="
          wget -O PandoraBox.bin \
            http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ralink-mt7620-phicomm-k1-2018-12-31-git-4b6a3d5ca-squashfs-sysupgrade.bin \
            --timeout=30 --tries=3 || { echo "固件下载失败"; exit 1; }
          
          ls -lh PandoraBox.bin
          file PandoraBox.bin
          echo "=== 固件准备完成 ==="

      - name: 清理残留目录+FMK自动解包（修复冲突）
        run: |
          # 核心修复：先删除已有目录，避免冲突
          rm -rf fmk_work
          mkdir -p fmk_work
          
          echo "=== FMK自动解包固件 ==="
          # 帖子推荐命令：自动识别TRX/uImage格式，精准分离各部分
          ./fmk/extract-firmware.sh PandoraBox.bin fmk_work
          
          # 验证解包成功（帖子强调检查rootfs目录）
          if [ ! -d "fmk_work/rootfs" ]; then
            echo "ERROR: FMK解包失败，无rootfs目录！"
            ls -l fmk_work/  # 输出解包目录，方便排错
            exit 1
          fi
          echo "✅ FMK自动解包完成"
          ls -l fmk_work/rootfs/ | head -n10

      - name: 直接重新打包（无修改，验证流程）
        run: |
          echo "=== 用FMK自动打包（贴合帖子格式要求） ==="
          cd fmk_work
          # 帖子核心打包命令：自动重建TRX/uImage头部，保留原格式
          # 指定Squashfs版本为4.0（原固件版本，避免兼容问题）
          ../fmk/build-firmware.sh \
            -s 4.0 \  # 关键：匹配原固件Squashfs版本（帖子强调版本一致）
            -o ../Modified_PandoraBox_K1_Original.bin
          
          cd ../
          if [ ! -f "Modified_PandoraBox_K1_Original.bin" ]; then
            echo "ERROR: 打包失败"
            exit 1
          fi
          echo "✅ 打包完成"

      - name: 验证新固件（帖子推荐的完整性检查）
        run: |
          echo "=== 原固件 vs 新固件 对比 ==="
          ls -lh PandoraBox.bin Modified_PandoraBox_K1_Original.bin
          ORIG_SIZE=$(stat -c%s "PandoraBox.bin")
          NEW_SIZE=$(stat -c%s "Modified_PandoraBox_K1_Original.bin")
          DIFF=$((NEW_SIZE - ORIG_SIZE))
          echo "大小差异：$DIFF 字节（±100KB内均正常）"
          
          # 验证固件格式（帖子强调必须是TRX/uImage格式）
          file Modified_PandoraBox_K1_Original.bin
          if ! file Modified_PandoraBox_K1_Original.bin | grep -E "TRX|uImage"; then
            echo "ERROR: 新固件格式异常！"
            exit 1
          fi
          echo "✅ 新固件格式验证通过"

      - name: 上传最终固件
        uses: actions/upload-artifact@v4
        with:
          name: PandoraBox_K1_FMK_Repacked
          path: Modified_PandoraBox_K1_Original.bin
          retention-days: 30
