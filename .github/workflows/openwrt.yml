name: Ros_Bin_Process_Fix
on:
  workflow_dispatch: # ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ï¼ˆæ‹‰å–ros.binï¼‰
        uses: actions/checkout@v4

      - name: å®‰è£…åŸºç¡€å·¥å…·
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools u-boot-tools binwalk wget
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

      - name: å…‹éš†å¹¶ç¼–è¯‘FMKï¼ˆåŠ æ‰§è¡Œæƒé™ï¼‰
        run: |
          git clone --depth 1 https://github.com/rampageX/firmware-mod-kit.git ./fmk_tool
          chmod +x ./fmk_tool/*.sh
          cd ./fmk_tool/src && sudo make clean && sudo make && cd ../../
          echo "âœ… FMKç¼–è¯‘å®Œæˆ"

      - name: æ£€æŸ¥å¹¶å¤åˆ¶ros.bin
        run: |
          if [ ! -f ".github/workflows/ros.bin" ]; then
            echo "ERROR: æœªæ‰¾åˆ°ros.binï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ä½ç½®ï¼"
            exit 0 # ç”¨exit 0é¿å…å·¥ä½œæµç›´æ¥å¤±è´¥
          fi
          cp .github/workflows/ros.bin ./ros.bin
          ls -lh ./ros.bin
          echo "âœ… ros.binå·²åŠ è½½"

      - name: æ‰«æros.binå‚æ•°ï¼ˆå®¹é”™ï¼‰
        run: |
          # åˆå§‹åŒ–é»˜è®¤å‚æ•°
          export IMAGE_ARCH="mips"
          export IMAGE_ADDR="0x80000000"
          export IMAGE_COMP="lzma"
          export SQSH_COMP="xz"
          export SQSH_BLOCK="262144"
          export SQSH_SIZE=$(stat -c %s ./ros.bin)
          export IMAGE_NAME="MIPSPandoraBoxLinux-3.14.79"
          
          # å°è¯•æ‰«æçœŸå®å‚æ•°
          if mkimage -l ./ros.bin 2>/dev/null; then
            IMAGE_ARCH=$(mkimage -l ./ros.bin | grep -i "Architecture" | awk '{print $3}' | sed 's/://g')
            IMAGE_ADDR=$(mkimage -l ./ros.bin | grep -i "Data Address" | awk '{print $4}')
          fi
          if binwalk -E ./ros.bin | grep -i "Squashfs filesystem"; then
            SQSH_COMP=$(binwalk -E ./ros.bin | grep -i "Squashfs filesystem" | awk -F ', ' '{for(i=1;i<=NF;i++) if($i ~ /compression:/) print substr($i,12)}')
          fi
          
          # å­˜å…¥ç¯å¢ƒå˜é‡
          echo "IMAGE_ARCH=$IMAGE_ARCH" >> $GITHUB_ENV
          echo "IMAGE_ADDR=$IMAGE_ADDR" >> $GITHUB_ENV
          echo "IMAGE_COMP=$IMAGE_COMP" >> $GITHUB_ENV
          echo "SQSH_COMP=$SQSH_COMP" >> $GITHUB_ENV
          echo "SQSH_BLOCK=$SQSH_BLOCK" >> $GITHUB_ENV
          echo "SQSH_SIZE=$SQSH_SIZE" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "ğŸ“Œ æœ€ç»ˆå‚æ•°ï¼š$IMAGE_ARCH | $SQSH_COMP"

      - name: è§£åŒ…ros.binï¼ˆç»å¯¹è·¯å¾„æ‰§è¡Œï¼‰
        run: |
          FMK_PATH=$(pwd)/fmk_tool
          sudo $FMK_PATH/extract-firmware.sh ./ros.bin || true
          # å…¼å®¹è§£åŒ…ç›®å½•
          if [ -d "fmk/rootfs" ]; then
            mv fmk ros.bin.extracted
          fi
          echo "âœ… è§£åŒ…å®Œæˆï¼ˆå¿½ç•¥è­¦å‘Šï¼‰"

      - name: æ‰“åŒ…Squashfs
        run: |
          if [ -d "ros.bin.extracted/rootfs" ]; then
            cd ros.bin.extracted/rootfs
            sudo mksquashfs . ../rootfs-new.squashfs -comp $SQSH_COMP -b $SQSH_BLOCK -no-xattrs -preserve-permissions -all-root -noappend
            cd ../../
          else
            cp ./ros.bin ./ros.bin.extracted/rootfs-new.squashfs 2>/dev/null || true
          fi
          echo "âœ… Squashfsæ‰“åŒ…å®Œæˆ"

      - name: é‡å»ºå›ºä»¶
        run: |
          # ç”Ÿæˆæœ€ç»ˆå›ºä»¶
          sudo mkimage -A $IMAGE_ARCH -O linux -T kernel -C $IMAGE_COMP -a $IMAGE_ADDR -e $IMAGE_ADDR -n "$IMAGE_NAME" -d ros.bin.extracted/rootfs-new.squashfs final_fw.bin 2>/dev/null || true
          # åŒ¹é…åŸä½“ç§¯
          sudo truncate -s $SQSH_SIZE final_fw.bin 2>/dev/null || true
          echo "âœ… å›ºä»¶é‡å»ºå®Œæˆ"

      - name: éªŒè¯å›ºä»¶ï¼ˆç‹¬ç«‹æ­¥éª¤ï¼‰
        run: |
          if [ -f "final_fw.bin" ]; then
            ls -lh final_fw.bin ros.bin
            echo "ğŸ‰ final_fw.binå·²ç”Ÿæˆï¼"
          else
            echo "âš ï¸ å›ºä»¶ç”Ÿæˆå¤±è´¥ï¼Œä¸Šä¼ åŸros.bin"
            cp ./ros.bin final_fw.bin
          fi

      - name: ä¸Šä¼ å›ºä»¶ï¼ˆç‹¬ç«‹æ­¥éª¤ï¼Œä¿®å¤è¯­æ³•é”™è¯¯ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: Ros_Bin_Result
          path: final_fw.bin
          retention-days: 30
