name: FMK自动解包+打包（潘多拉终极稳定版）
on:
  workflow_dispatch:  # 手动触发
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装依赖（含FMK必需工具）
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev \
            binwalk squashfs-tools u-boot-tools mtd-utils file wget
          echo "=== 工具安装完成 ==="

      - name: 下载并编译Firmware Mod Kit（帖子核心工具）
        run: |
          echo "=== 下载FMK工具 ==="
          git clone https://github.com/rampageX/firmware-mod-kit.git fmk
          cd fmk/src
          # 编译FMK（帖子强调必须编译才能使用）
          make clean && make
          cd ../../
          echo "=== FMK编译完成 ==="

      - name: 自动下载潘多拉K1固件
        run: |
          echo "=== 下载固件 ==="
          wget -O PandoraBox.bin \
            http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ralink-mt7620-phicomm-k1-2018-12-31-git-4b6a3d5ca-squashfs-sysupgrade.bin \
            --timeout=30 --tries=3 || { echo "固件下载失败"; exit 1; }
          
          ls -lh PandoraBox.bin
          file PandoraBox.bin
          echo "=== 固件准备完成 ==="

      - name: 超级清理+FMK自动解包（终极修复冲突）
        run: |
          echo "=== 彻底清理残留目录 ==="
          # 终极清理：sudo强制删除，确保无任何残留
          sudo rm -rf fmk_work 2>/dev/null
          # 不提前创建目录，让FMK自动创建（彻底避免存在性检测）
          
          echo "=== FMK自动解包固件 ==="
          # 帖子推荐命令，添加-v参数输出详细日志，方便排错
          ./fmk/extract-firmware.sh -v PandoraBox.bin fmk_work
          
          # 验证解包成功（帖子强调检查rootfs目录）
          if [ ! -d "fmk_work/rootfs" ]; then
            echo "ERROR: FMK解包失败，无rootfs目录！"
            echo "=== 解包目录详情 ==="
            ls -la fmk_work/  # 输出所有文件，包括隐藏文件
            exit 1
          fi
          echo "✅ FMK自动解包完成"
          ls -l fmk_work/rootfs/ | head -n10

      - name: 直接重新打包（无修改，验证流程）
        run: |
          echo "=== 用FMK自动打包（贴合帖子格式要求） ==="
          cd fmk_work
          # 帖子核心打包命令，添加-v参数输出详细日志
          ../fmk/build-firmware.sh -v \
            -s 4.0 \  # 匹配原固件Squashfs 4.0版本
            -o ../Modified_PandoraBox_K1_Original.bin
          
          cd ../
          if [ ! -f "Modified_PandoraBox_K1_Original.bin" ]; then
            echo "ERROR: 打包失败"
            exit 1
          fi
          echo "✅ 打包完成"

      - name: 验证新固件（帖子推荐的完整性检查）
        run: |
          echo "=== 原固件 vs 新固件 对比 ==="
          ls -lh PandoraBox.bin Modified_PandoraBox_K1_Original.bin
          ORIG_SIZE=$(stat -c%s "PandoraBox.bin")
          NEW_SIZE=$(stat -c%s "Modified_PandoraBox_K1_Original.bin")
          DIFF=$((NEW_SIZE - ORIG_SIZE))
          echo "大小差异：$DIFF 字节（±100KB内均正常）"
          
          # 验证固件格式（帖子强调必须是TRX/uImage格式）
          file Modified_PandoraBox_K1_Original.bin
          if ! file Modified_PandoraBox_K1_Original.bin | grep -E "TRX|uImage"; then
            echo "ERROR: 新固件格式异常！"
            exit 1
          fi
          echo "✅ 新固件格式验证通过"

      - name: 上传最终固件+解包日志
        uses: actions/upload-artifact@v4
        with:
          name: PandoraBox_K1_FMK_Repacked
          path: |
            Modified_PandoraBox_K1_Original.bin
            fmk_work/  # 上传解包目录，方便后续排错
          retention-days: 30