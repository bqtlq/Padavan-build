name: 最后一次尝试（彻底清理工具目录）
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 只装必需依赖
        run: sudo apt update -y && sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools wget

      - name: 彻底清理所有FMK相关目录（关键修复）
        run: sudo rm -rf fmk fw.bin.extracted final_fw.bin 2>/dev/null

      - name: 重新下载+编译FMK（确保干净）
        run: git clone --depth 1 https://github.com/rampageX/firmware-mod-kit.git fmk && cd fmk/src && sudo make clean && sudo make && cd ../../

      - name: 下载固件
        run: wget -O fw.bin http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ralink-mt7620-phicomm-k1-2018-12-31-git-4b6a3d5ca-squashfs-sysupgrade.bin --timeout=30 --tries=3

      - name: 解包（无任何多余参数）
        run: sudo ./fmk/extract-firmware.sh fw.bin

      - name: 打包（无任何多余参数）
        run: cd fw.bin.extracted && sudo ../../fmk/build-firmware.sh -s 4.0 -o ../../final_fw.bin && cd ../../

      - name: 强制上传（不管成功失败都传）
        uses: actions/upload-artifact@v4
        with:
          name: last_try_firmware
          path: |
            final_fw.bin
            fw.bin.extracted/logs/ 2>/dev/null || true
          retention-days: 30
