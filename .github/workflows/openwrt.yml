name: 纯解包+直接打包（稳定版，无兼容报错）
on:
  workflow_dispatch:  # 手动触发
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  verify-firmware-process:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装核心依赖工具
        run: |
          sudo apt update -y
          sudo apt install -y binwalk squashfs-tools build-essential mtd-utils file wget u-boot-tools
          echo "=== 工具版本验证 ==="
          mksquashfs -version | head -n1
          unsquashfs -version | head -n1
          mkimage -V | head -n1

      - name: 自动下载潘多拉K1固件
        run: |
          echo "=== 开始下载固件 ==="
          wget -O PandoraBox.bin \
            http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ralink-mt7620-phicomm-k1-2018-12-31-git-4b6a3d5ca-squashfs-sysupgrade.bin \
            --timeout=30 \
            --tries=3 || { echo "ERROR: 固件下载失败"; exit 1; }
          
          echo "=== 原固件信息 ==="
          ls -lh PandoraBox.bin
          ORIGINAL_SIZE=$(stat -c%s "PandoraBox.bin")
          echo "原固件大小：$ORIGINAL_SIZE 字节"
          binwalk -x none PandoraBox.bin | grep -E "uImage|Squashfs"
          
          file PandoraBox.bin
          if ! file PandoraBox.bin | grep -q "uImage"; then
            echo "ERROR: 下载的固件不是uImage格式！"
            exit 1
          fi
          echo "✅ 固件下载并验证成功"

      - name: 精准解包（保留权限）
        run: |
          mkdir -p firmware_split rootfs
          echo "=== 开始精准解包 ==="
          
          UIMAGE_HEADER_SIZE=64
          SQUASHFS_OFFSET=$((0x162FAA))
          
          # 分离uImage头部
          dd if=PandoraBox.bin of=firmware_split/uimage_header.bin bs=1 count=$UIMAGE_HEADER_SIZE 2>/dev/null
          echo "✅ 已分离uImage头部（$UIMAGE_HEADER_SIZE字节）"
          
          # 分离Squashfs镜像
          dd if=PandoraBox.bin of=firmware_split/rootfs.squashfs bs=1 skip=$SQUASHFS_OFFSET 2>/dev/null
          if ! file firmware_split/rootfs.squashfs | grep -q "Squashfs filesystem"; then
            echo "ERROR: Squashfs镜像无效！"
            file firmware_split/rootfs.squashfs
            exit 1
          fi
          echo "✅ Squashfs镜像验证有效"
          
          # 解包：跳过设备文件，保留原权限
          unsquashfs -n -p 4 -d rootfs firmware_split/rootfs.squashfs || true
          # 修复权限（避免启动时权限错误）
          sudo chown -R root:root rootfs/ 2>/dev/null || true
          
          # 验证核心目录
          if [ ! -d "rootfs/etc" ] || [ ! -d "rootfs/usr" ] || [ ! -d "rootfs/bin" ]; then
            echo "ERROR: 解包失败，核心目录不存在！"
            exit 1
          fi
          echo "✅ Squashfs解包完成"
          ls -l rootfs/ | head -n10

      - name: 重新打包（无兼容报错）
        run: |
          echo "=== 开始重新打包Squashfs ==="
          # 彻底移除 -Xbcj mips，仅保留稳定核心参数
          mksquashfs rootfs/ firmware_split/new_rootfs.squashfs \
            -comp xz \                # 与原固件一致的压缩格式
            -b 262144 \               # 256K块大小（原固件参数）
            -noappend \               # 不追加模式
            -all-root \               # 所有文件归属root
            -preserve-permissions \   # 保留原文件权限（稳定关键）
            -no-xattrs \              # 禁用扩展属性（兼容老固件）
            -processors 2             # 多线程加速
          
          if [ ! -f "firmware_split/new_rootfs.squashfs" ]; then
            echo "ERROR: 打包失败"
            exit 1
          fi
          echo "✅ Squashfs打包完成（无兼容报错）"
          ls -lh firmware_split/new_rootfs.squashfs

      - name: 重建uImage头部（确保启动）
        run: |
          echo "=== 重建uImage头部并合并固件 ==="
          mkimage \
            -A mips \
            -O linux \
            -T kernel \
            -C lzma \
            -a 0x80000000 \
            -e 0x80000000 \
            -n "MIPS PandoraBox Linux-3.14.79" \
            -d firmware_split/new_rootfs.squashfs \
            Modified_PandoraBox_K1_Original.bin
          
          if [ ! -f "Modified_PandoraBox_K1_Original.bin" ]; then
            echo "ERROR: 固件合并失败"
            exit 1
          fi
          
          # 验证新固件结构
          echo "=== 新固件结构验证 ==="
          binwalk -x none Modified_PandoraBox_K1_Original.bin | grep -E "uImage|Squashfs"
          if ! binwalk -x none Modified_PandoraBox_K1_Original.bin | grep -q "Squashfs filesystem"; then
            echo "ERROR: 新固件缺少Squashfs文件系统！"
            exit 1
          fi
          
          echo "=== 原固件 vs 新固件 大小对比 ==="
          ls -lh PandoraBox.bin Modified_PandoraBox_K1_Original.bin
          NEW_SIZE=$(stat -c%s "Modified_PandoraBox_K1_Original.bin")
          ORIGINAL_SIZE=$(stat -c%s "PandoraBox.bin")
          DIFF=$((NEW_SIZE - ORIGINAL_SIZE))
          echo "大小差异：$DIFF 字节（±500KB内均正常）"
          
          echo "✅ 可刷机固件生成完成！"

      - name: 上传验证用固件
        uses: actions/upload-artifact@v4
        with:
          name: PandoraBox_K1_Original_Repacked
          path: Modified_PandoraBox_K1_Original.bin
          retention-days: 30
