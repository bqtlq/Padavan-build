name: Use_Local_Ros_Bin
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ï¼ˆæ‹‰å–æœ¬åœ°ros.binï¼‰
        uses: actions/checkout@v4

      - name: å®‰è£…å·¥å…·ï¼ˆå»æ‰firmware-mod-kitçš„aptå®‰è£…ï¼‰
        run: |
          sudo apt update -y
          # åˆ æ‰firmware-mod-kitï¼Œåç»­æ‰‹åŠ¨å…‹éš†ç¼–è¯‘
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools u-boot-tools binwalk wget
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ"

      - name: æ‰‹åŠ¨å…‹éš†+ç¼–è¯‘FMKï¼ˆæ›¿ä»£aptå®‰è£…ï¼‰
        run: |
          git clone --depth 1 https://github.com/rampageX/firmware-mod-kit.git fmk_tool
          cd fmk_tool/src
          sudo make clean && sudo make
          cd ../../
          echo "âœ… FMKæ‰‹åŠ¨ç¼–è¯‘å®Œæˆ"

      - name: æ¸…ç†æ®‹ç•™æ–‡ä»¶
        run: sudo rm -rf fmk* ros.bin.extracted final_fw.bin 2>/dev/null

      - name: ç¡®è®¤ros.binå­˜åœ¨ï¼ˆå…³é”®æ£€æŸ¥ï¼‰
        run: |
          if [ ! -f ".github/workflows/ros.bin" ]; then
            echo "ERROR: ä»“åº“çš„.github/workflows/ç›®å½•ä¸‹æœªæ‰¾åˆ°ros.binï¼"
            exit 1
          fi
          # å¤åˆ¶åˆ°å·¥ä½œæ ¹ç›®å½•ï¼Œæ–¹ä¾¿æ“ä½œ
          cp .github/workflows/ros.bin ./ros.bin
          ls -lh ros.bin
          echo "âœ… å·²æ‰¾åˆ°å¹¶åŠ è½½ros.bin"

      - name: è‡ªåŠ¨æ‰«æros.binæ ¸å¿ƒå‚æ•°
        id: scan
        run: |
          echo "=== æ‰«æuImageå¤´éƒ¨å‚æ•° ==="
          # æå–å‚æ•°ï¼ˆå®¹é”™å¤„ç†ï¼Œé¿å…å‚æ•°ç¼ºå¤±ï¼‰
          export IMAGE_ARCH=$(mkimage -l ros.bin | grep -i "Architecture" | awk '{print $3}' | sed 's/://g' || echo "mips")
          export IMAGE_ADDR=$(mkimage -l ros.bin | grep -i "Data Address" | awk '{print $4}' || echo "0x80000000")
          export IMAGE_ENTRY=$(mkimage -l ros.bin | grep -i "Entry Point" | awk '{print $4}' || echo $IMAGE_ADDR)
          export IMAGE_COMP=$(mkimage -l ros.bin | grep -i "Compression" | awk '{print $3}' | sed 's/://g' || echo "lzma")
          export IMAGE_NAME=$(mkimage -l ros.bin | grep -i "Image Name" | cut -d ':' -f2 | sed 's/ //g' || echo "Linux-Kernel")
          
          echo "=== æ‰«æSquashfså‚æ•° ==="
          export SQSH_COMP=$(binwalk -E ros.bin | grep -i "Squashfs filesystem" | awk -F ', ' '{for(i=1;i<=NF;i++) if($i ~ /compression:/) print substr($i,12)}' || echo "xz")
          export SQSH_BLOCK=$(binwalk -E ros.bin | grep -i "Squashfs filesystem" | awk -F ', ' '{for(i=1;i<=NF;i++) if($i ~ /blocksize:/) print substr($i,11) | sed 's/ bytes//g'}' || echo "262144")
          export SQSH_SIZE=$(stat -c %s ros.bin) # åŸå›ºä»¶ä½“ç§¯
          
          # è¾“å‡ºæ‰«æç»“æœ
          echo "ğŸ“Œ uImageå‚æ•°ï¼šæ¶æ„=$IMAGE_ARCH | åœ°å€=$IMAGE_ADDR | å‹ç¼©=$IMAGE_COMP"
          echo "ğŸ“Œ Squashfså‚æ•°ï¼šå‹ç¼©=$SQSH_COMP | å—å¤§å°=$SQSH_BLOCK | ä½“ç§¯=$SQSH_SIZE"
          
          # å­˜å…¥ç¯å¢ƒå˜é‡
          echo "IMAGE_ARCH=$IMAGE_ARCH" >> $GITHUB_ENV
          echo "IMAGE_ADDR=$IMAGE_ADDR" >> $GITHUB_ENV
          echo "IMAGE_ENTRY=$IMAGE_ENTRY" >> $GITHUB_ENV
          echo "IMAGE_COMP=$IMAGE_COMP" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "SQSH_COMP=$SQSH_COMP" >> $GITHUB_ENV
          echo "SQSH_BLOCK=$SQSH_BLOCK" >> $GITHUB_ENV
          echo "SQSH_SIZE=$SQSH_SIZE" >> $GITHUB_ENV

      - name: ç”¨æ‰‹åŠ¨ç¼–è¯‘çš„FMKè§£åŒ…ros.bin
        run: |
          # æ”¹ç”¨æ‰‹åŠ¨å…‹éš†çš„FMKè„šæœ¬è§£åŒ…ï¼Œè€Œéç³»ç»Ÿå‘½ä»¤
          sudo ./fmk_tool/extract-firmware.sh ros.bin
          if [ ! -d "ros.bin.extracted/rootfs" ] && [ ! -d "fmk/rootfs" ]; then
            echo "ERROR: ros.binè§£åŒ…å¤±è´¥ï¼ŒéuImage+Squashfsæ¶æ„ï¼"
            exit 1
          fi
          # å…¼å®¹FMKçš„è§£åŒ…ç›®å½•ï¼ˆæ—§ç‰ˆä¼šç”Ÿæˆfmkç›®å½•ï¼‰
          if [ -d "fmk/rootfs" ]; then
            mv fmk ros.bin.extracted
          fi
          echo "âœ… ros.binè§£åŒ…å®Œæˆ"

      - name: æŒ‰æ‰«æå‚æ•°æ‰“åŒ…Squashfs
        run: |
          cd ros.bin.extracted/rootfs
          sudo mksquashfs . ../rootfs-new.squashfs -comp $SQSH_COMP -b $SQSH_BLOCK -no-xattrs -preserve-permissions -all-root -noappend
          cd ../../
          echo "âœ… Squashfsæ‰“åŒ…å®Œæˆ"

      - name: ç”¨æ‰‹åŠ¨ç¼–è¯‘çš„FMKé‡å»ºå›ºä»¶+è¡¥å…¨uImageå¤´éƒ¨
        run: |
          cd ros.bin.extracted
          # å…ˆè°ƒç”¨FMKçš„buildè„šæœ¬ï¼Œå†ç”¨mkimageè¡¥å…¨å¤´éƒ¨å‚æ•°
          sudo ../fmk_tool/build-firmware.sh .
          cd ../
          # ç”¨æ‰«æçš„å‚æ•°é‡æ–°ç”ŸæˆuImageå¤´éƒ¨ï¼ˆç¡®ä¿å‚æ•°åŒ¹é…ï¼‰
          sudo mkimage -A $IMAGE_ARCH -O linux -T kernel -C $IMAGE_COMP -a $IMAGE_ADDR -e $IMAGE_ENTRY -n "$IMAGE_NAME" -d ros.bin.extracted/rootfs-new.squashfs final_fw.bin
          sudo truncate -s $SQSH_SIZE final_fw.bin # åŒ¹é…åŸå›ºä»¶ä½“ç§¯
          echo "âœ… å›ºä»¶é‡å»º+å¤´éƒ¨è¡¥å…¨å®Œæˆ"

      - name: éªŒè¯æœ€ç»ˆå›ºä»¶
        run: |
          ls -lh final_fw.bin ros.bin
          file final_fw.bin
          echo "ğŸ‰ ros.binå¤„ç†å®Œæˆï¼final_fw.bin å¯ç›´æ¥åˆ·æœº"

      - name: ä¸Šä¼ å¤„ç†åçš„å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: Ros_Bin_Final_Firmware
          path: final_fw.bin
          retention-days: 30
