name: FMK_Old_Script_Workflow（稳定版）
on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装FMK官方依赖（兼容old脚本）
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential zlib1g-dev liblzma-dev liblzo2-dev squashfs-tools u-boot-tools binwalk automake autoconf libtool pkg-config
          echo "✅ 依赖安装完成"

      - name: 终极清理（彻底删除所有冲突目录）
        run: |
          sudo rm -rf firmware-mod-kit fmk fmk_old ./fmk* final_fw.bin ros.bin 2>/dev/null
          echo "✅ 所有残留清理完成"

      - name: 克隆FMK官方仓库
        run: |
          git clone https://github.com/rampageX/firmware-mod-kit.git fmk
          cd fmk
          # 编译old脚本依赖（官方要求）
          ./configure && make
          # 给old脚本加执行权限
          chmod +x old-extract.sh old-build.sh
          cd ../
          echo "✅ FMK及old脚本编译完成"

      - name: 复制固件（换固件仅改这里）
        run: |
          FW_NAME="ros.bin"
          if [ -f ".github/workflows/$FW_NAME" ]; then
            cp .github/workflows/$FW_NAME ./$FW_NAME
            chmod 644 ./$FW_NAME
            echo "✅ 加载固件：$FW_NAME"
          else
            echo "ERROR: 未找到$FW_NAME，请检查路径"
            exit 1
          fi
          echo "FW_NAME=$FW_NAME" >> $GITHUB_ENV

      - name: 用old-extract.sh解包（兼容Padavan，无目录冲突）
        run: |
          # old-extract.sh不会强制检测目录，且支持更多格式
          sudo ./fmk/old-extract.sh ./$FW_NAME
          # 验证解包成功（old脚本解包后仍生成fmk目录）
          if [ ! -d "fmk/rootfs" ]; then
            echo "ERROR: 解包失败，可能固件格式不支持（尝试手动确认是否为uImage/Squashfs）"
            exit 1
          fi
          echo "✅ 用old脚本解包完成，支持Padavan等定制固件"

      - name: 用old-build.sh打包（解决不开机问题）
        run: |
          cd fmk
          # old-build.sh会完全复用原固件参数（地址、压缩、分区等），打包后能开机
          sudo ./old-build.sh
          cd ../
          # 复制最终固件（old脚本打包后输出为fmk/firmware.bin）
          cp fmk/firmware.bin final_fw.bin
          echo "✅ 用old脚本打包完成，参数完全匹配原固件"

      - name: 上传可开机固件
        uses: actions/upload-artifact@v4
        with:
          name: Padavan_Working_Firmware
          path: final_fw.bin
          retention-days: 30
