name: 自动下载+解包删除PPPoE+打包PandoraBox固件（MT7620-K1专用）
on:
  workflow_dispatch:  # 手动触发（推荐）
  push:
    paths:
      - '.github/workflows/openwrt.yml'

jobs:
  modify-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装核心依赖工具
        run: |
          sudo apt update -y
          sudo apt install -y binwalk squashfs-tools build-essential mtd-utils file wget
          echo "=== 工具版本验证 ==="
          mksquashfs -version | head -n1
          unsquashfs -version | head -n1
          wget --version | head -n1

      - name: 自动下载潘多拉K1固件
        run: |
          echo "=== 开始下载固件 ==="
          wget -O PandoraBox.bin \
            http://downloads.pangubox.com:6380/pandorabox/19.01/targets/ralink/mt7620/PandoraBox-ralink-mt7620-phicomm-k1-2018-12-31-git-4b6a3d5ca-squashfs-sysupgrade.bin \
            --timeout=30 \
            --tries=3 || { echo "ERROR: 固件下载失败"; exit 1; }
          
          echo "=== 下载的固件信息 ==="
          ls -lh PandoraBox.bin
          FILE_SIZE=$(stat -c%s "PandoraBox.bin")
          if [ $FILE_SIZE -lt 6000000 ]; then
            echo "ERROR: 固件文件过小，下载不完整（大小：$FILE_SIZE 字节）"
            exit 1
          fi
          
          file PandoraBox.bin
          if ! file PandoraBox.bin | grep -q "uImage"; then
            echo "ERROR: 下载的固件不是uImage格式！"
            exit 1
          fi
          echo "✅ 固件下载并验证成功"

      - name: 精准解包uImage格式固件（最终修复版）
        run: |
          mkdir -p firmware_split rootfs
          echo "=== 开始精准解包 ==="
          
          UIMAGE_HEADER_SIZE=64
          SQUASHFS_OFFSET=$((0x162FAA))
          
          # 分离uImage头部
          dd if=PandoraBox.bin of=firmware_split/uimage_header.bin bs=1 count=$UIMAGE_HEADER_SIZE 2>/dev/null
          echo "✅ 已分离uImage头部（$UIMAGE_HEADER_SIZE字节）"
          
          # 提取Squashfs镜像
          dd if=PandoraBox.bin of=firmware_split/rootfs.squashfs bs=1 skip=$SQUASHFS_OFFSET 2>/dev/null
          if ! file firmware_split/rootfs.squashfs | grep -q "Squashfs filesystem"; then
            echo "ERROR: Squashfs镜像无效！"
            file firmware_split/rootfs.squashfs
            exit 1
          fi
          echo "✅ Squashfs镜像验证有效"
          
          # 最终修复：忽略设备文件导致的非零退出码，用后续验证替代强制退出
          unsquashfs -n -d rootfs firmware_split/rootfs.squashfs || true
          
          # 关键验证：检查核心目录是否存在（确认解包真成功）
          if [ ! -d "rootfs/etc" ] || [ ! -d "rootfs/usr" ]; then
            echo "ERROR: 解包失败，核心目录（etc/usr）不存在！"
            ls -l rootfs/
            exit 1
          fi
          
          echo "✅ Squashfs解包完成（已跳过设备文件创建）"
          ls -l rootfs/ | head -n10

      - name: 彻底删除PPPoE组件
        run: |
          cd rootfs || { echo "ERROR: 进入根目录失败"; exit 1; }
          echo "=== 开始删除PPPoE组件 ==="
          
          # 删除二进制文件
          rm -rf ./usr/sbin/pppoe* ./usr/bin/pppoe* ./usr/sbin/pppd* 2>/dev/null || true
          # 删除配置与脚本
          rm -f ./etc/config/pppoe ./etc/ppp/peers/pppoe* ./etc/init.d/pppoe 2>/dev/null || true
          # 删除包信息
          rm -rf ./usr/lib/opkg/info/pppoe* ./usr/lib/opkg/info/ppp-mod-pppoe* 2>/dev/null || true
          # 清理opkg状态
          sed -i '/Package: ppp-mod-pppoe/,/^$/d' ./usr/lib/opkg/status 2>/dev/null || true
          sed -i '/Package: pppoe/,/^$/d' ./usr/lib/opkg/status 2>/dev/null || true
          # 清理残留
          残留文件=$(find . -name "*pppoe*" -o -name "*pppd*" 2>/dev/null)
          if [ -n "$残留文件" ]; then
            find . -name "*pppoe*" -o -name "*pppd*" -exec rm -rf {} \; 2>/dev/null || true
            echo "✅ 删除残留文件：$残留文件"
          else
            echo "✅ 无PPPoE残留文件"
          fi
          cd ../

      - name: 重新打包Squashfs镜像
        run: |
          echo "=== 开始重新打包 ==="
          mksquashfs rootfs/ firmware_split/new_rootfs.squashfs \
            -comp xz -b 262144 -noappend -all-root -processors 2
          
          if [ ! -f "firmware_split/new_rootfs.squashfs" ]; then
            echo "ERROR: 打包失败"
            exit 1
          fi
          echo "✅ Squashfs打包完成，大小：$(ls -lh firmware_split/new_rootfs.squashfs | awk '{print $5}')"

      - name: 合并生成可刷机固件
        run: |
          echo "=== 合并固件 ==="
          cat firmware_split/uimage_header.bin firmware_split/new_rootfs.squashfs > Modified_PandoraBox_K1_NoPPPoE.bin
          
          if [ ! -f "Modified_PandoraBox_K1_NoPPPoE.bin" ]; then
            echo "ERROR: 合并失败"
            exit 1
          fi
          
          echo "=== 最终固件信息 ==="
          ls -lh Modified_PandoraBox_K1_NoPPPoE.bin
          file Modified_PandoraBox_K1_NoPPPoE.bin
          echo "✅ 可刷机固件生成完成！"

      - name: 上传最终固件
        uses: actions/upload-artifact@v4
        with:
          name: PandoraBox_K1_NoPPPoE_Firmware
          path: Modified_PandoraBox_K1_NoPPPoE.bin
          retention-days: 90
